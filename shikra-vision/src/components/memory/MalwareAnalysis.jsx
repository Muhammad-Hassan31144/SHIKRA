import React, { useMemo } from 'react';
import {
  ShieldExclamationIcon,
  BugAntIcon,
  ExclamationTriangleIcon,
  EyeIcon,
  DocumentTextIcon
} from '@heroicons/react/24/outline';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const MalwareAnalysis = ({ memoryData }) => {
  const malwareAnalysis = memoryData?.analysis_results?.malware_analysis || {};
  const malfindResults = malwareAnalysis.malfind_results || [];
  const codeInjection = malwareAnalysis.code_injection || [];
  const rootkitArtifacts = malwareAnalysis.rootkit_artifacts || [];

  // Statistics
  const stats = useMemo(() => {
    return {
      totalMalfindHits: malfindResults.length,
      totalInjections: codeInjection.length,
      totalRootkits: rootkitArtifacts.length,
      avgEntropy: malfindResults.length > 0 
        ? (malfindResults.reduce((acc, m) => acc + (m.entropy || 0), 0) / malfindResults.length).toFixed(2)
        : 0
    };
  }, [malfindResults, codeInjection, rootkitArtifacts]);

  // Chart data for malfind entropy analysis
  const entropyData = useMemo(() => {
    return malfindResults.map((result, index) => ({
      name: `${result.process_name || 'Unknown'}-${index}`,
      entropy: result.entropy || 0,
      size: result.size || 0,
      pid: result.pid
    }));
  }, [malfindResults]);

  const CustomTooltip = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white dark:bg-gray-800 p-3 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg">
          <p className="font-medium text-gray-900 dark:text-white">{`${label}`}</p>
          {payload.map((entry, index) => (
            <p key={index} style={{ color: entry.color }}>
              {`${entry.dataKey}: ${entry.value}`}
            </p>
          ))}
        </div>
      );
    }
    return null;
  };

  return (
    <div className="space-y-6">
      {/* Statistics Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <div className="flex items-center">
            <BugAntIcon className="h-8 w-8 text-red-500" />
            <div className="ml-3">
              <p className="text-sm text-gray-500 dark:text-gray-400">Malfind Hits</p>
              <p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.totalMalfindHits}</p>
            </div>
          </div>
        </div>
        
        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <div className="flex items-center">
            <ExclamationTriangleIcon className="h-8 w-8 text-orange-500" />
            <div className="ml-3">
              <p className="text-sm text-gray-500 dark:text-gray-400">Code Injections</p>
              <p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.totalInjections}</p>
            </div>
          </div>
        </div>
        
        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <div className="flex items-center">
            <EyeIcon className="h-8 w-8 text-purple-500" />
            <div className="ml-3">
              <p className="text-sm text-gray-500 dark:text-gray-400">Rootkit Artifacts</p>
              <p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.totalRootkits}</p>
            </div>
          </div>
        </div>
        
        <div className="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <div className="flex items-center">
            <DocumentTextIcon className="h-8 w-8 text-blue-500" />
            <div className="ml-3">
              <p className="text-sm text-gray-500 dark:text-gray-400">Avg Entropy</p>
              <p className="text-2xl font-bold text-gray-900 dark:text-white">{stats.avgEntropy}</p>
            </div>
          </div>
        </div>
      </div>

      {/* Entropy Analysis Chart */}
      {entropyData.length > 0 && (
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
          <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">Entropy Analysis</h3>
          <div className="h-80">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={entropyData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#E5E7EB" />
                <XAxis 
                  dataKey="name" 
                  stroke="#6B7280"
                  fontSize={11}
                  angle={-45}
                  textAnchor="end"
                  height={80}
                />
                <YAxis stroke="#6B7280" fontSize={12} />
                <Tooltip content={<CustomTooltip />} />
                <Legend />
                <Bar dataKey="entropy" fill="#DC2626" name="Entropy" />
              </BarChart>
            </ResponsiveContainer>
          </div>
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">
            High entropy values (&gt;7.0) typically indicate encrypted or packed content, which may be malicious.
          </p>
        </div>
      )}

      {/* Malfind Results */}
      {malfindResults.length > 0 && (
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
          <div className="flex items-center mb-4">
            <BugAntIcon className="h-6 w-6 text-red-500 mr-2" />
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Malfind Results</h3>
          </div>
          <div className="space-y-4">
            {malfindResults.map((result, index) => (
              <div key={index} className="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                <div className="flex justify-between items-start mb-3">
                  <div>
                    <h4 className="font-medium text-gray-900 dark:text-white">
                      {result.process_name} (PID: {result.pid})
                    </h4>
                    <p className="text-sm text-gray-500 dark:text-gray-400">
                      Address: {result.address} | Size: {result.size} bytes
                    </p>
                  </div>
                  <div className="text-right">
                    <div className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      result.entropy > 7.5 ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' :
                      result.entropy > 6.5 ? 'bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200' :
                      'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200'
                    }`}>
                      Entropy: {result.entropy}
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* Memory Protection Info */}
                  <div>
                    <h5 className="font-medium text-gray-900 dark:text-white mb-2">Memory Protection</h5>
                    <div className="space-y-1 text-sm">
                      <div><span className="text-gray-500 dark:text-gray-400">Protection:</span> {result.protection}</div>
                      <div><span className="text-gray-500 dark:text-gray-400">Commit Charge:</span> {result.commit_charge}</div>
                      <div><span className="text-gray-500 dark:text-gray-400">Tag:</span> {result.tag}</div>
                      <div><span className="text-gray-500 dark:text-gray-400">Private Memory:</span> {result.privatememory ? 'Yes' : 'No'}</div>
                    </div>
                  </div>

                  {/* PE Characteristics */}
                  {result.pe_characteristics && (
                    <div>
                      <h5 className="font-medium text-gray-900 dark:text-white mb-2">PE Characteristics</h5>
                      <div className="space-y-1 text-sm">
                        <div><span className="text-gray-500 dark:text-gray-400">Is PE:</span> {result.pe_characteristics.is_pe ? 'Yes' : 'No'}</div>
                        <div><span className="text-gray-500 dark:text-gray-400">Has Relocations:</span> {result.pe_characteristics.has_relocations ? 'Yes' : 'No'}</div>
                        <div><span className="text-gray-500 dark:text-gray-400">Is Stripped:</span> {result.pe_characteristics.is_stripped ? 'Yes' : 'No'}</div>
                      </div>
                    </div>
                  )}
                </div>

                {/* YARA Matches */}
                {result.yara_matches && result.yara_matches.length > 0 && (
                  <div className="mt-4">
                    <h5 className="font-medium text-gray-900 dark:text-white mb-2">YARA Matches</h5>
                    <div className="space-y-2">
                      {result.yara_matches.map((match, matchIndex) => (
                        <div key={matchIndex} className="p-2 bg-red-50 dark:bg-red-900 rounded text-sm">
                          <div className="font-medium text-red-800 dark:text-red-200">{match.rule}</div>
                          {match.strings && match.strings.map((str, strIndex) => (
                            <div key={strIndex} className="text-red-600 dark:text-red-300 ml-2">
                              {str.identifier}: {str.data} (offset: {str.offset})
                            </div>
                          ))}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Disassembly */}
                {result.disassembly && result.disassembly.length > 0 && (
                  <div className="mt-4">
                    <h5 className="font-medium text-gray-900 dark:text-white mb-2">Disassembly</h5>
                    <div className="bg-gray-900 dark:bg-gray-950 p-3 rounded font-mono text-sm text-green-400 overflow-x-auto">
                      {result.disassembly.map((line, lineIndex) => (
                        <div key={lineIndex}>{line}</div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Hexdump */}
                {result.hexdump && (
                  <div className="mt-4">
                    <h5 className="font-medium text-gray-900 dark:text-white mb-2">Hexdump</h5>
                    <div className="bg-gray-900 dark:bg-gray-950 p-3 rounded font-mono text-sm text-blue-400 break-all">
                      {result.hexdump}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Code Injection Analysis */}
      {codeInjection.length > 0 && (
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
          <div className="flex items-center mb-4">
            <ExclamationTriangleIcon className="h-6 w-6 text-orange-500 mr-2" />
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Code Injection Detection</h3>
          </div>
          <div className="space-y-4">
            {codeInjection.map((injection, index) => (
              <div key={index} className="border border-orange-200 dark:border-orange-800 rounded-lg p-4 bg-orange-50 dark:bg-orange-900/20">
                <div className="flex justify-between items-start mb-3">
                  <div>
                    <h4 className="font-medium text-gray-900 dark:text-white">
                      {injection.injection_type?.replace('_', ' ')?.toUpperCase() || 'Code Injection'}
                    </h4>
                    <p className="text-sm text-gray-600 dark:text-gray-300">
                      {injection.injector_name} (PID: {injection.injector_pid}) â†’ {injection.target_name} (PID: {injection.target_pid})
                    </p>
                  </div>
                  <div className="text-right">
                    <div className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200">
                      Confidence: {((injection.detection_confidence || 0) * 100).toFixed(0)}%
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-500 dark:text-gray-400">Injected Address:</span> {injection.injected_address}
                  </div>
                  <div>
                    <span className="text-gray-500 dark:text-gray-400">Injected Size:</span> {injection.injected_size} bytes
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Rootkit Artifacts */}
      {rootkitArtifacts.length > 0 && (
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
          <div className="flex items-center mb-4">
            <EyeIcon className="h-6 w-6 text-purple-500 mr-2" />
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white">Rootkit Artifacts</h3>
          </div>
          <div className="space-y-4">
            {rootkitArtifacts.map((artifact, index) => (
              <div key={index} className="border border-purple-200 dark:border-purple-800 rounded-lg p-4 bg-purple-50 dark:bg-purple-900/20">
                <div className="flex justify-between items-start mb-3">
                  <div>
                    <h4 className="font-medium text-gray-900 dark:text-white">
                      {artifact.type?.replace('_', ' ')?.toUpperCase() || 'Rootkit Artifact'}
                    </h4>
                    <p className="text-sm text-gray-600 dark:text-gray-300">
                      {artifact.name} (PID: {artifact.pid})
                    </p>
                  </div>
                  <div className="text-right">
                    <div className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">
                      {artifact.hiding_technique?.replace('_', ' ') || 'Unknown Technique'}
                    </div>
                  </div>
                </div>
                <div className="text-sm">
                  <span className="text-gray-500 dark:text-gray-400">Evidence:</span>
                  <p className="text-gray-900 dark:text-white mt-1">{artifact.evidence}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* No Malware Found */}
      {malfindResults.length === 0 && codeInjection.length === 0 && rootkitArtifacts.length === 0 && (
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-8">
          <div className="text-center">
            <ShieldExclamationIcon className="mx-auto h-12 w-12 text-green-500" />
            <h3 className="mt-2 text-sm font-medium text-gray-900 dark:text-white">No Malware Detected</h3>
            <p className="mt-1 text-sm text-gray-500 dark:text-gray-400">
              No malicious artifacts, code injection, or rootkit activity was detected in the memory image.
            </p>
          </div>
        </div>
      )}
    </div>
  );
};

export default MalwareAnalysis;
