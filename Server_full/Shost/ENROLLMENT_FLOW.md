## Agent v2.0 Enrollment Flow vs Old System

### OLD SYSTEM (Shikra.ini) - DEPRECATED ❌
```
┌─────────────┐
│   Admin     │
│  Dashboard  │
└──────┬──────┘
       │ 1. Create VM Config
       ▼
┌─────────────────┐
│  vm_config.py   │ Generates:
│                 │ • agent_id (pre-assigned)
│                 │ • agent_secret (pre-generated)
│                 │ • Shikra.ini file
└────────┬────────┘
         │ 2. Download Shikra.ini
         ▼
┌─────────────────┐
│   Windows VM    │
│                 │ Agent reads:
│  Shikra.ini:    │ • agent_id=agent-win10
│  agent_id=...   │ • agent_secret=abc123
│  agent_secret=..│ • host_api_url=...
└────────┬────────┘
         │ 3. Agent connects with pre-configured ID
         ▼
┌─────────────────┐
│  Shost Server   │
│                 │ Validates:
│  agents.json    │ • Check if agent_id exists
│  {              │ • Verify agent_secret matches
│    "agent-win10"│
│    ...          │
│  }              │
└─────────────────┘

PROBLEMS:
• Agent v2.0 doesn't read INI files
• Pre-configured secrets less secure
• No enrollment verification
• Requires manual file transfer
```

### NEW SYSTEM (Enrollment Key) - Agent v2.0 ✅
```
┌─────────────┐
│   Admin     │
│  Dashboard  │
└──────┬──────┘
       │ 1. Generate Enrollment Key
       ▼
┌──────────────────────┐
│  enrollment.py       │ Creates:
│                      │ • Secure random key (48 bytes)
│  POST /enrollment/   │ • SHA256 hash (stored)
│       keys/generate  │ • Expiry (7 days default)
└──────────┬───────────┘
           │ 2. Returns key ONCE
           │    (never stored in plaintext)
           ▼
      ┌─────────────────────────────────────┐
      │ enrollment_key:                     │
      │ xK9mP2nQ7vR4wS8tU1yZ3aB...         │
      └─────────────────────────────────────┘
           │ 3. Admin copies key
           ▼
┌─────────────────────────────────────┐
│       Windows VM                    │
│                                     │
│ > ShikraAgent.exe --enroll \        │
│     xK9mP2nQ7vR4wS8tU1yZ3aB...     │
│                                     │
│ Enter Shost URL: http://192...     │
└──────────┬──────────────────────────┘
           │ 4. Agent sends enrollment request
           ▼
┌──────────────────────────────────────┐
│  Shost Server                        │
│                                      │
│  POST /api/v1/agent/register         │
│  {                                   │
│    "enrollment_key": "xK9mP...",     │
│    "hostname": "WIN10-VM",           │
│    "machine_fingerprint": "..."      │
│  }                                   │
└──────────┬───────────────────────────┘
           │ 5. Validates enrollment key
           │    (checks SHA256 hash)
           │    (verifies not expired)
           │    (marks as used)
           ▼
┌──────────────────────────────────────┐
│  Response:                           │
│  {                                   │
│    "agent_id": "agent-win10-abc",    │
│    "token": "eyJ0eXAi...",          │ ← JWT or similar
│    "host_api_url": "http://...",    │
│    "poll_interval_ms": 30000         │
│  }                                   │
└──────────┬───────────────────────────┘
           │ 6. Agent saves credentials
           ▼
┌──────────────────────────────────────┐
│  C:\SecurityHealth\                  │
│    agent_config.json                 │
│  {                                   │
│    "agent_id": "agent-win10-abc",    │
│    "token": "eyJ0eXAi...",          │
│    "host_api_url": "http://...",    │
│    ...                               │
│  }                                   │
└──────────┬───────────────────────────┘
           │ 7. Agent starts polling
           ▼
┌──────────────────────────────────────┐
│  GET /api/v1/agents/next-sample      │
│  Authorization: Bearer eyJ0eXAi...   │
│  X-Agent-ID: agent-win10-abc         │
└──────────────────────────────────────┘

BENEFITS:
✅ Enrollment key shown only once (more secure)
✅ Agent auto-generates config.json
✅ Token-based auth (no hardcoded secrets)
✅ Expiry enforcement (keys expire in 7 days)
✅ One-time use (key invalidated after enrollment)
✅ Machine fingerprint tracking (detect VM clones)
```

### Security Comparison

| Feature | Old (INI) | New (Enrollment) |
|---------|-----------|------------------|
| Secret Storage | Plaintext in INI file | SHA256 hash only |
| Secret Visibility | Stored on disk permanently | Shown once, never logged |
| Credential Transfer | Manual file copy | Secure key exchange |
| Key Expiry | No expiry | 7 days default |
| One-time Use | No (reusable) | Yes (invalidated after use) |
| VM Clone Detection | No | Yes (machine fingerprint) |
| Token Rotation | Manual | Automatic on enrollment |

### File Structure Comparison

**Old System:**
```
data/
  vm_configs/
    win10.ini          ← Generated by vm_config.py
    win10.json         ← Metadata with agent_id/secret
  agents.json          ← Pre-populated with agent_id/secret
```

**New System:**
```
data/
  agents.json          ← Empty until enrollment
    {
      "agent-win10-abc": {
        "enrollment_key_hash": "sha256...",
        "enrollment_used": true,
        "token_sha": "sha256...",
        "machine_fingerprint": "...",
        ...
      }
    }
```

### Migration Checklist

- [ ] Stop using `vm_config.py` to generate INI files
- [ ] Delete old `Shikra.ini` files from VMs
- [ ] Clear `data/agents.json` to start fresh: `echo '{}' > data/agents.json`
- [ ] Use new enrollment API: `POST /api/v1/enrollment/keys/generate`
- [ ] Deploy Agent v2.0 with `--enroll` flag
- [ ] Verify agent creates `agent_config.json` correctly
- [ ] Test end-to-end flow with `test_enrollment.sh`
